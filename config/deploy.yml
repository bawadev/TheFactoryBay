# Factory Bay - Kamal Deployment Config
# Copy to bawaDev/TheFactoryBay repo as config/deploy.yml
# Reference: server-credentials.md
# Uses Traefik (from Appwrite) for reverse proxy and SSL

service: factory-bay
image: ghcr.io/bawadev/factory-bay

servers:
  web:
    hosts:
      - 185.211.6.206
    labels:
      traefik.enable: "true"
      traefik.constraint-label-stack: "appwrite"
      traefik.http.routers.factory-bay.rule: "Host(\`dev.renfy.style\`)"
      traefik.http.routers.factory-bay.entrypoints: "appwrite_websecure"
      traefik.http.routers.factory-bay.tls: "true"
      traefik.http.routers.factory-bay.tls.certresolver: "dns"
      traefik.http.services.factory-bay.loadbalancer.server.port: "3000"
      traefik.docker.network: "gateway"
    options:
      network: gateway

registry:
  server: ghcr.io
  username: bawadev
  password:
    - KAMAL_REGISTRY_PASSWORD

ssh:
  user: root

# Disable kamal-proxy - using Traefik instead
proxy: false

env:
  clear:
    NODE_ENV: production
    NEO4J_URI: neo4j://185.211.6.206:7687
    NEO4J_USER: neo4j
    MINIO_ENDPOINT: 185.211.6.206
    MINIO_PORT: "9000"
    MINIO_BUCKET_NAME: product-images
    MINIO_USE_SSL: "false"
    NEXT_PUBLIC_MINIO_URL: http://185.211.6.206:9000
    NEXT_PUBLIC_APP_URL: https://dev.renfy.style
    PORT: "3000"
  secret:
    - KAMAL_REGISTRY_PASSWORD
    - NEO4J_PASSWORD
    - JWT_SECRET
    - MINIO_ACCESS_KEY
    - MINIO_SECRET_KEY

builder:
  arch: amd64
